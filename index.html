import React, { useState, useEffect, useRef, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, onSnapshot, collection, query, addDoc, serverTimestamp, orderBy, getDocs } from 'firebase/firestore';

// --- GLOBAL VARIABLES SETUP (MANDATORY CANVAS REQUIREMENTS) ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
const apiKey = ""; // API key is handled by the canvas environment for fetch calls

// Utility function to handle exponential backoff for API calls
const fetchWithRetry = async (url, options, maxRetries = 5) => {
    let lastError = null;
    for (let i = 0; i < maxRetries; i++) {
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response;
        } catch (error) {
            lastError = error;
            console.warn(`Attempt ${i + 1} failed. Retrying in ${2 ** i}s...`);
            await new Promise(resolve => setTimeout(resolve, (2 ** i) * 1000));
        }
    }
    throw new Error(`Failed to fetch after ${maxRetries} attempts: ${lastError.message}`);
};


// --- FIREBASE AND CHAT LOGIC ---

// Define the structure for the log item
const CHAT_LOG_COLLECTION = "chat_logs"; // Private per user
const INSIGHTS_COLLECTION = "insights_reports"; // Private per user

// System Prompt for the core Chatbot (The Sales Assistant)
const CHATBOT_SYSTEM_PROMPT = `
You are the "River Mounts AI Sales Assistant," an expert internal consultant specializing in River Mounts Jewellery's product and service offerings, B2B sales protocols, and CX strategy.

Your persona is highly professional, concise, and strategic. Your role is to quickly and accurately provide the sales team with information to help them sell more effectively and manage customer expectations.

KNOWLEDGE BASE SUMMARY (Critical Information):
1. STRENGTH: River Mounts excels in **melee set (small) diamonds**, particularly **micro setting**. Promote this as the primary quality differentiator.
2. WEAKNESS/CX RISK: There are known sourcing challenges with **colour-matched rubies and emeralds**. Advise the sales team to set clear expectations and avoid overpromising quality/matching for these stones.
3. SHOWCASE FEATURE: The digital product showcase is highly customizable. Retailers can selectively hide specific designs, widths, or coverage options to curate their inventory.
4. FUTURE DEVELOPMENT: New lines include **Coloured Gemstones** (approx. 50 curated designs) and **Gents Diamond Set Designs** (3mm-8mm) planned for **2026**.

Answer user questions based on this knowledge. Be direct and avoid excessive small talk.
`;

// System Prompt for the Summary/Insights Report (For the Team Lead)
const INSIGHTS_SYSTEM_PROMPT = `
You are an AI Analyst. Your task is to analyze a list of user questions from a sales team and generate a concise report in Markdown format. Your primary objective is to identify **ambiguous, low-clarity, or frequently repeated questions**â€”these are the "instances where it is unable to provide clear answers" because the required knowledge/SOPs are likely missing or unclear internally.

The report must be structured into two sections:
1. **Top 3 Recurring Themes:** List the three most common or important topics the sales team is asking about (e.g., pricing, a specific product category, or a policy).
2. **Identified Knowledge Gaps (Actionable):** Based on the themes and ambiguity, suggest one specific area where the sales team likely needs additional training or clearer human-authored documentation (SOPs).

Analyze the following list of raw questions:
`;

function App() {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [messages, setMessages] = useState([]);
    const [input, setInput] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [report, setReport] = useState(null);
    const [isReporting, setIsReporting] = useState(false);

    const messagesEndRef = useRef(null);

    // 1. Initialize Firebase & Handle Anonymous Authentication (No Sign-in Required)
    useEffect(() => {
        try {
            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
            const authInstance = getAuth(app);

            setDb(firestore);
            setAuth(authInstance);

            const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                if (user) {
                    setUserId(user.uid);
                } else {
                    // Sign in anonymously if no existing user or token is available
                    if (initialAuthToken) {
                        await signInWithCustomToken(authInstance, initialAuthToken);
                    } else {
                        await signInAnonymously(authInstance);
                    }
                }
                setIsAuthReady(true);
            });

            return () => unsubscribe();
        } catch (error) {
            console.error("Firebase Initialization/Auth Error:", error);
            setIsAuthReady(true);
        }
    }, []);

    // 2. Real-time Message Listener (Logs all conversations)
    useEffect(() => {
        if (db && userId) {
            const logPath = `artifacts/${appId}/users/${userId}/${CHAT_LOG_COLLECTION}`;
            const q = query(collection(db, logPath), orderBy('timestamp', 'asc'));

            const unsubscribe = onSnapshot(q, (snapshot) => {
                const loadedMessages = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                setMessages(loadedMessages);
            }, (error) => {
                console.error("Error fetching messages:", error);
            });

            return () => unsubscribe();
        }
    }, [db, userId]);

    // Scroll to the latest message
    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    }, [messages]);

    // 3. AI Message Processing (LLM Call)
    const processAiResponse = useCallback(async (userQuery) => {
        if (!db || !userId) return;

        const logPath = `artifacts/${appId}/users/${userId}/${CHAT_LOG_COLLECTION}`;

        try {
            // Include context of the last 5 messages
            const history = messages.slice(-5).map(m => ({
                role: m.role === 'user' ? 'user' : 'model',
                parts: [{ text: m.text }]
            }));

            // Add the new user message to the history for the API context
            const contents = [...history, { role: 'user', parts: [{ text: userQuery }] }];

            const payload = {
                contents: contents,
                systemInstruction: { parts: [{ text: CHATBOT_SYSTEM_PROMPT }] },
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const response = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't generate a definitive response. This may indicate a policy or product detail that needs internal clarification. Please check the official SOPs or ask your Team Lead.";

            // Log AI response
            await addDoc(collection(db, logPath), {
                text: aiText,
                role: 'ai',
                timestamp: serverTimestamp(),
            });

        } catch (error) {
            console.error("AI Response Generation Error:", error);
            await addDoc(collection(db, logPath), {
                text: "An error occurred while connecting to the AI. Please try again.",
                role: 'ai',
                timestamp: serverTimestamp(),
            });
        } finally {
            setIsLoading(false);
        }
    }, [db, userId, messages]);


    // 4. Handle User Submission
    const handleSend = async (e) => {
        e.preventDefault();
        const userQuery = input.trim();
        if (!userQuery || !db || !userId || isLoading) return;

        setInput('');
        setIsLoading(true);

        const logPath = `artifacts/${appId}/users/${userId}/${CHAT_LOG_COLLECTION}`;

        // 1. Log User Message
        try {
            await addDoc(collection(db, logPath), {
                text: userQuery,
                role: 'user',
                timestamp: serverTimestamp(),
            });
            // 2. Initiate AI response
            await processAiResponse(userQuery);

        } catch (error) {
            console.error("Error logging user message:", error);
            setIsLoading(false);
        }
    };

    // 5. Generate Weekly Summary/Insights Report (For Team Lead Review)
    const generateInsightsReport = async () => {
        if (isReporting) return;
        setIsReporting(true);
        setReport(null);

        const logPath = `artifacts/${appId}/users/${userId}/${CHAT_LOG_COLLECTION}`;
        const summaryPath = `artifacts/${appId}/users/${userId}/${INSIGHTS_COLLECTION}`;

        try {
            // Fetch all user questions
            const q = query(collection(db, logPath), orderBy('timestamp', 'asc'));
            const snapshot = await getDocs(q);
            const userQuestions = snapshot.docs
                .filter(doc => doc.data().role === 'user')
                .map(doc => doc.data().text)
                .join('\n');

            if (userQuestions.length === 0) {
                setReport("No chat history available to generate a report.");
                setIsReporting(false);
                return;
            }

            const prompt = INSIGHTS_SYSTEM_PROMPT + '\n\n' + userQuestions;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: "You are an AI Analyst. Output only the Markdown report." }] },
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const response = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            const reportContent = result.candidates?.[0]?.content?.parts?.[0]?.text || "Failed to generate insights report.";
            setReport(reportContent);

            // Log the report itself for historical tracking
            await addDoc(collection(db, summaryPath), {
                report: reportContent,
                timestamp: serverTimestamp(),
                questions_count: userQuestions.length
            });

        } catch (error) {
            console.error("Insights Report Error:", error);
            setReport("An error occurred while generating the report. Please try again later.");
        } finally {
            setIsReporting(false);
        }
    };

    return (
        <div className="min-h-screen bg-gray-50 flex flex-col font-sans antialiased">
            <script src="https://cdn.tailwindcss.com"></script>
            <style>
                {`
                @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
                body { font-family: 'Inter', sans-serif; }

                /* River Mounts Brand Colors: Deep Green/Brown (#354409) */
                .brand-green { background-color: #354409; } 

                .chat-bubble-user {
                    background-color: #354409; 
                    color: white;
                    border-radius: 12px 12px 0 12px;
                }
                .chat-bubble-ai {
                    background-color: #e5e7eb; /* Light Gray for AI/System */
                    color: #1f2937; 
                    border-radius: 12px 12px 12px 0;
                }
                .scroll-container {
                    scrollbar-width: none;
                    -ms-overflow-style: none;
                }
                .scroll-container::-webkit-scrollbar {
                    display: none;
                }
                /* Hides the management console from the sales team view */
                .insights-console-hidden {
                    display: none;
                }
                `}
            </style>

            {/* Branded Header */}
            <header className="brand-green text-white p-4 shadow-lg sticky top-0 z-10 rounded-b-xl">
                <div className="flex justify-between items-center max-w-4xl mx-auto">
                    <h1 className="text-xl font-bold tracking-wider">River Mounts AI Sales Assistant</h1>
                    <p className="text-sm opacity-80">Ask me anything about our products or policy.</p>
                </div>
            </header>

            <main className="flex flex-1 overflow-hidden max-w-4xl mx-auto w-full p-0">
                <div className="flex flex-col w-full h-full bg-white rounded-xl shadow-2xl">

                    {/* Chat Area (Messenger View) */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 scroll-container">
                        {(!isAuthReady || !userId) && (
                            <div className="text-center p-6 text-sm text-gray-500 bg-gray-100 rounded-lg">
                                **Connecting to the system...** (No sign-in required)
                            </div>
                        )}
                        {messages.length === 0 && isAuthReady && userId && (
                            <div className="text-center p-6 text-sm text-gray-500 bg-gray-100 rounded-lg">
                                **Welcome!** I'm your expert assistant.
                                <ul className="mt-2 list-disc list-inside text-left mx-auto max-w-xs">
                                    <li>What is our specialty in **diamond setting**?</li>
                                    <li>What should I tell customers about **emerald** sourcing?</li>
                                    <li>What **new product lines** are coming in 2026?</li>
                                </ul>
                            </div>
                        )}

                        {messages.map((msg) => (
                            <div key={msg.id} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-xs sm:max-w-md p-3 shadow-md text-sm ${msg.role === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}`}>
                                    {msg.text.split('\n').map((line, index) => (
                                        <p key={index}>{line}</p>
                                    ))}
                                </div>
                            </div>
                        ))}
                        {isLoading && (
                            <div className="flex justify-start">
                                <div className="max-w-xs sm:max-w-md p-3 shadow-md text-sm chat-bubble-ai">
                                    <div className="flex items-center space-x-2">
                                        <svg className="animate-spin h-4 w-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>Typing...</span>
                                    </div>
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    {/* Input Area */}
                    <form onSubmit={handleSend} className="p-4 border-t border-gray-200">
                        <div className="flex space-x-2">
                            <input
                                type="text"
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                placeholder="Ask a product or process question..."
                                className="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-[#354409] focus:border-[#354409]"
                                disabled={isLoading || !isAuthReady || !userId}
                            />
                            <button
                                type="submit"
                                className={`px-4 py-3 text-sm font-semibold rounded-lg transition duration-150 ${
                                    isLoading || !isAuthReady || !userId
                                        ? 'bg-gray-400 cursor-not-allowed'
                                        : 'brand-green hover:bg-opacity-90 text-white shadow-md'
                                }`}
                                disabled={isLoading || !isAuthReady || !userId}
                            >
                                Send
                            </button>
                        </div>
                    </form>
                </div>
            </main>

            {/* Team Lead Summary Section (Hidden from users, retained for manager's use) */}
            <section className="bg-gray-100 p-4 border-t border-gray-200 mt-4 rounded-t-xl insights-console-hidden">
                <div className="max-w-4xl mx-auto">
                    <h2 className="text-lg font-semibold text-gray-700 mb-3">Team Lead Insights Console</h2>
                    <p className="text-sm text-gray-600 mb-4">This report analyzes all team questions to identify recurring themes and knowledge gaps, fulfilling the request to log instances where clarity is needed.</p>
                    <button
                        onClick={generateInsightsReport}
                        className={`w-full md:w-auto px-4 py-2 text-sm font-semibold rounded-lg transition duration-150 ${
                            isReporting
                                ? 'bg-orange-400 cursor-not-allowed'
                                : 'bg-orange-600 hover:bg-orange-700 text-white shadow-md'
                        }`}
                        disabled={isReporting || !isAuthReady || !userId}
                    >
                        {isReporting ? 'Generating Report...' : 'Generate Weekly Insights Report'}
                    </button>

                    {report && (
                        <div className="mt-4 p-4 bg-white border border-orange-300 rounded-lg shadow-inner">
                            <h3 className="font-bold text-base text-orange-700 mb-2">AI-Generated Insights</h3>
                            <div className="prose text-sm" dangerouslySetInnerHTML={{ __html: report.replace(/\n/g, '<br/>') }} />
                        </div>
                    )}
                </div>
            </section>
        </div>
    );
}

export default App;
```eof
